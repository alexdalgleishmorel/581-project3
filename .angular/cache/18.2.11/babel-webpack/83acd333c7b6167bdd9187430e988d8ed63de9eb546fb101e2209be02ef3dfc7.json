{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport * as tf from '@tensorflow/tfjs-core';\nimport { createCanvas, createCanvasFromMedia, getContext2dOrThrow } from '../dom';\nimport { env } from '../env';\nimport { normalize } from './normalize';\nexport function extractImagePatches(img, boxes, _a) {\n  var width = _a.width,\n    height = _a.height;\n  return __awaiter(this, void 0, void 0, function () {\n    var imgCtx, bitmaps, imagePatchesDatas;\n    var _this = this;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          imgCtx = getContext2dOrThrow(img);\n          return [4 /*yield*/, Promise.all(boxes.map(function (box) {\n            return __awaiter(_this, void 0, void 0, function () {\n              var _a, y, ey, x, ex, fromX, fromY, imgData;\n              return __generator(this, function (_b) {\n                _a = box.padAtBorders(img.height, img.width), y = _a.y, ey = _a.ey, x = _a.x, ex = _a.ex;\n                fromX = x - 1;\n                fromY = y - 1;\n                imgData = imgCtx.getImageData(fromX, fromY, ex - fromX, ey - fromY);\n                return [2 /*return*/, env.isNodejs() ? createCanvasFromMedia(imgData) : createImageBitmap(imgData)];\n              });\n            });\n          }))];\n        case 1:\n          bitmaps = _b.sent();\n          imagePatchesDatas = [];\n          bitmaps.forEach(function (bmp) {\n            var patch = createCanvas({\n              width: width,\n              height: height\n            });\n            var patchCtx = getContext2dOrThrow(patch);\n            patchCtx.drawImage(bmp, 0, 0, width, height);\n            var data = patchCtx.getImageData(0, 0, width, height).data;\n            var currData = [];\n            // RGBA -> BGR\n            for (var i = 0; i < data.length; i += 4) {\n              currData.push(data[i + 2]);\n              currData.push(data[i + 1]);\n              currData.push(data[i]);\n            }\n            imagePatchesDatas.push(currData);\n          });\n          return [2 /*return*/, imagePatchesDatas.map(function (data) {\n            var t = tf.tidy(function () {\n              var imagePatchTensor = tf.transpose(tf.tensor4d(data, [1, width, height, 3]), [0, 2, 1, 3]).toFloat();\n              return normalize(imagePatchTensor);\n            });\n            return t;\n          })];\n      }\n    });\n  });\n}","map":{"version":3,"names":["__awaiter","__generator","tf","createCanvas","createCanvasFromMedia","getContext2dOrThrow","env","normalize","extractImagePatches","img","boxes","_a","width","height","imgCtx","bitmaps","imagePatchesDatas","_this","_b","label","Promise","all","map","box","y","ey","x","ex","fromX","fromY","imgData","padAtBorders","getImageData","isNodejs","createImageBitmap","sent","forEach","bmp","patch","patchCtx","drawImage","data","currData","i","length","push","t","tidy","imagePatchTensor","transpose","tensor4d","toFloat"],"sources":["/Users/alexdalgleishmorel/Desktop/UofC/FALL 24/581/581-project3/node_modules/face-api.js/build/es6/mtcnn/extractImagePatches.js"],"sourcesContent":["import { __awaiter, __generator } from \"tslib\";\r\nimport * as tf from '@tensorflow/tfjs-core';\r\nimport { createCanvas, createCanvasFromMedia, getContext2dOrThrow } from '../dom';\r\nimport { env } from '../env';\r\nimport { normalize } from './normalize';\r\nexport function extractImagePatches(img, boxes, _a) {\r\n    var width = _a.width, height = _a.height;\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var imgCtx, bitmaps, imagePatchesDatas;\r\n        var _this = this;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    imgCtx = getContext2dOrThrow(img);\r\n                    return [4 /*yield*/, Promise.all(boxes.map(function (box) { return __awaiter(_this, void 0, void 0, function () {\r\n                            var _a, y, ey, x, ex, fromX, fromY, imgData;\r\n                            return __generator(this, function (_b) {\r\n                                _a = box.padAtBorders(img.height, img.width), y = _a.y, ey = _a.ey, x = _a.x, ex = _a.ex;\r\n                                fromX = x - 1;\r\n                                fromY = y - 1;\r\n                                imgData = imgCtx.getImageData(fromX, fromY, (ex - fromX), (ey - fromY));\r\n                                return [2 /*return*/, env.isNodejs() ? createCanvasFromMedia(imgData) : createImageBitmap(imgData)];\r\n                            });\r\n                        }); }))];\r\n                case 1:\r\n                    bitmaps = _b.sent();\r\n                    imagePatchesDatas = [];\r\n                    bitmaps.forEach(function (bmp) {\r\n                        var patch = createCanvas({ width: width, height: height });\r\n                        var patchCtx = getContext2dOrThrow(patch);\r\n                        patchCtx.drawImage(bmp, 0, 0, width, height);\r\n                        var data = patchCtx.getImageData(0, 0, width, height).data;\r\n                        var currData = [];\r\n                        // RGBA -> BGR\r\n                        for (var i = 0; i < data.length; i += 4) {\r\n                            currData.push(data[i + 2]);\r\n                            currData.push(data[i + 1]);\r\n                            currData.push(data[i]);\r\n                        }\r\n                        imagePatchesDatas.push(currData);\r\n                    });\r\n                    return [2 /*return*/, imagePatchesDatas.map(function (data) {\r\n                            var t = tf.tidy(function () {\r\n                                var imagePatchTensor = tf.transpose(tf.tensor4d(data, [1, width, height, 3]), [0, 2, 1, 3]).toFloat();\r\n                                return normalize(imagePatchTensor);\r\n                            });\r\n                            return t;\r\n                        })];\r\n            }\r\n        });\r\n    });\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}